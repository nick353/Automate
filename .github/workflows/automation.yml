name: Browser Automation Task

on:
  repository_dispatch:
    types: [run-browser-task]

# åŒæ™‚å®Ÿè¡Œã‚’åˆ¶é™ï¼ˆåŒã˜ã‚¿ã‚¹ã‚¯ãŒè¤‡æ•°èµ°ã‚‰ãªã„ã‚ˆã†ã«ï¼‰
concurrency:
  group: browser-task-${{ github.event.client_payload.task_id }}
  cancel-in-progress: false

env:
  PYTHONUNBUFFERED: "1"

jobs:
  execute-browser-task:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # æœ€å¤§30åˆ†ï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰
    
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # 2. Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # 3. ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install browser-use langchain-anthropic playwright httpx
      
      # 4. Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆé‡è¦ï¼ï¼‰
      - name: Install Playwright browsers
        run: |
          playwright install chromium
          playwright install-deps chromium
      
      # 5. è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
      - name: Execute automation task
        id: execute
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TASK_ID: ${{ github.event.client_payload.task_id }}
          EXECUTION_ID: ${{ github.event.client_payload.execution_id }}
          TASK_PROMPT: ${{ github.event.client_payload.task_prompt }}
          TARGET_URL: ${{ github.event.client_payload.target_url }}
          MAX_STEPS: ${{ github.event.client_payload.max_steps }}
          CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
          # è¿½åŠ ã®èªè¨¼æƒ…å ±ï¼ˆå¿…è¦ã«å¿œã˜ã¦Secretsã‹ã‚‰å–å¾—ï¼‰
          SITE_USERNAME: ${{ secrets.SITE_USERNAME }}
          SITE_PASSWORD: ${{ secrets.SITE_PASSWORD }}
        run: |
          python automation_script.py
        continue-on-error: true
      
      # 6. çµæžœã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: automation-results-${{ github.event.client_payload.execution_id }}
          path: |
            results/
            screenshots/
          retention-days: 7
      
      # 7. çµæžœã‚’Webhookã§é€šçŸ¥ï¼ˆZeaburã«é€ä¿¡ï¼‰
      - name: Send result to callback
        if: always()
        env:
          CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
          EXECUTION_ID: ${{ github.event.client_payload.execution_id }}
          TASK_ID: ${{ github.event.client_payload.task_id }}
        run: |
          if [ -n "$CALLBACK_URL" ]; then
            # çµæžœãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
            if [ -f "results/result.json" ]; then
              RESULT=$(cat results/result.json)
            else
              RESULT='{"success": false, "error": "Result file not found"}'
            fi
            
            # Webhookã«é€ä¿¡
            curl -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -H "X-GitHub-Execution-ID: $EXECUTION_ID" \
              -d "{
                \"execution_id\": $EXECUTION_ID,
                \"task_id\": $TASK_ID,
                \"status\": \"${{ steps.execute.outcome }}\",
                \"result\": $RESULT,
                \"run_id\": ${{ github.run_id }},
                \"run_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
              }" || echo "Callback failed (non-critical)"
          fi
      
      # 8. å®Ÿè¡Œçµæžœã®ã‚µãƒžãƒªãƒ¼ã‚’å‡ºåŠ›
      - name: Job Summary
        if: always()
        run: |
          echo "## ðŸ¤– Browser Automation Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Task ID**: ${{ github.event.client_payload.task_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Execution ID**: ${{ github.event.client_payload.execution_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ steps.execute.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "results/result.json" ]; then
            echo "### Result" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat results/result.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
